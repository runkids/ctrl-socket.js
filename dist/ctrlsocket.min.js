!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.CtrlSocket=t()}(this,function(){"use strict";var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}(),o=WebSocket.CONNECTING,i=WebSocket.OPEN,r=WebSocket.CLOSING,s=WebSocket.CLOSED,a=Symbol("initWebsocketEvent"),u=Symbol("clearTimer"),c=Symbol("doRetry"),l=Symbol("doHeartCheck"),h=function(){};return function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.url=e,this.ws=null,this.wsState=s,this.timer=null,this.retryConfig={count:0,interval:5e3,tried:0},this.heartBeatConfig={doCheck:!1,timeout:null,message:null,timeoutObj:null,serverTimeoutObj:null},this.listener={onopen:h,onmessage:h,onerror:h,onclose:h}}return e(t,[{key:u,value:function(){clearInterval(this.timer),this.timer=null}},{key:a,value:function(){var t=this;this.ws.onopen=function(e){t.retryConfig.tried=0,t.wsState=i,t.listener.onopen(e),t.heartBeatConfig.doCheck&&t[l]().start()},this.ws.onmessage=function(e){t.listener.onmessage(e),t.heartBeatConfig.doCheck&&t[l]().reset().start()},this.ws.onerror=this.listener.onerror,this.ws.onclose=function(e){t.wsState=s,t[u](),t.ws=null,t.listener.onclose(e),t.heartBeatConfig.doCheck&&t[l]().reset(),0!==t.retryConfig.count&&1e3!==e.code&&t[c]()}}},{key:c,value:function(){var e=this.retryConfig,t=e.count,n=e.interval,o=e.tried;t?this.wsState!==WebSocket.OPEN&&o<t-1?(this.reconnect(n),this.retryConfig.tried+=1):this.retryConfig.tried=0:this.reconnect(n)}},{key:l,value:function(){var e=this,t=this.heartBeatConfig,n=t.timeout,o=t.message;return{reset:function(){return clearTimeout(e.heartBeatConfig.timeoutObj),clearTimeout(e.heartBeatConfig.serverTimeoutObj),this},start:function(){e.heartBeatConfig.timeoutObj=setTimeout(function(){e.send(o),e.heartBeatConfig.serverTimeoutObj=setTimeout(function(){e.disconnect(4e3,"Loss connection")},1e4)},n)}}}},{key:"subscribe",value:function(e){return"function"==typeof e?this.listener.onmessage=e:this.listener=Object.assign(this.listener,e),this}},{key:"connect",value:function(){if(this.wsState!==s)throw new Error("Connection is busy, please try again later.");return this.wsState=o,this.ws=new WebSocket(this.url),this[a](),this}},{key:"disconnect",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1e3,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"Normal closure";if(e&&1e3===!e||4999<=e&&e<=3e3)throw new Error("Invalid code");if(null===this.ws||this.wsState!==i)throw new Error("Connection has already been closed");this.wsState=r;this.retryConfig.tried=0,this.ws.close(e,t,!0)}},{key:"reconnect",value:function(){var e=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:5e3;void 0===this.timer&&null===this.timer||this[u](),this.timer=setInterval(function(){e.wsState===s&&e.connect()},t)}},{key:"retry",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:5e3;if(e<0)throw new Error("Retry count must not be less than 0");return this.retryConfig=Object.assign(this.retryConfig,{count:e,interval:t}),this}},{key:"heartBeat",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:3e4,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{command:"ping"};return this.heartBeatConfig={doCheck:!0,timeout:e,message:t},this}},{key:"send",value:function(e){if(this.readyState===o)throw new Error("The connection has not been established yet");this.readyState===i&&("object"===(void 0===e?"undefined":n(e))&&(e=JSON.stringify(e)),this.ws.send(e))}},{key:"readyState",get:function(){return this.wsState}}]),t}()});
